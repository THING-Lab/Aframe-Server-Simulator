<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>vadapav scene</title>
  <meta name="description" content="vadapav scene">
  <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>
  <script src="https://requirejs.org/docs/release/2.3.5/minified/require.js"></script>
</head>
<body>
<a-scene>
  <a-assets>
    <img id="groundTexture" src="https://cdn.aframe.io/a-painter/images/floor.jpg" crossorigin="anonymous">
    <img id="skyTexture" src="https://cdn.aframe.io/a-painter/images/sky.jpg" crossorigin="anonymous">
    <script src="/socket.io/socket.io.js"></script>
    <img id="netTexture" src="img/net_texture.jpg" crossorigin="anonymous">
    <img id="ballTexture" src="img/football_texture.png" crossorigin="anonymous">
  </a-assets>
  
  <a-entity  id="cameraParent">
  </a-entity>
  
  <a-entity  id="cameraProxy">
    <a-camera id="qtmObject" ></a-camera>
  </a-entity>
  
  <!-- <a-entity id="anAvatar" scale="2 2 2" geometry="primitive: torusKnot" position="0 6 -10" material="color: magenta; metalness:1; roughness: 0.1; sphericalEnvMap: #sky;">
    <a-animation easing="linear" attribute="rotation" dur="10000" to="0 0 360" repeat="indefinite"></a-animation>
  </a-entity> -->

  <!-- Primitives. -->
  <a-sphere
    id="anAvatar"
    position="0 0.5 0"
    radius="0.5"
    rotation="0 0 0"
    color="#FFFFFF"
    src = "#ballTexture"
    animation="property: rotation; to: 0 360 0; dur: 10000;"
    animation__mouseenter="property: components.material.material.color; type: color; to: red; startEvents: mouseenter; dur: 500";
    animation__mouseleave="property: components.material.material.color; type: color; to: white; startEvents: mouseleave; dur: 500";>
  </a-sphere>
  <a-plane position="0 .1 -5" rotation="-90 0 0" width="25" height="25" color="#2BC8A4"></a-plane>

  <!-- Background sky. -->
  <a-sky height="2048" radius="30" src="#skyTexture" theta-length="90" width="2048"></a-sky>

  <!-- Ground. -->
  <a-circle src="#groundTexture" rotation="-90 0 0" radius="32"></a-circle>

  <!--Tracked controls. -->
  <!-- <a-entity hand-controls="hand: left"></a-entity>
  <a-entity hand-controls="hand: right"></a-entity> -->
</a-scene>
</body>


<script>

  var scene = document.querySelector('a-scene');
  var box = document.createElement('a-box');
  box.setAttribute('color', 'yellow');
  box.setAttribute('height', '12.5');
  box.setAttribute('width', '15');
  box.setAttribute('depth', '1.75');
  box.setAttribute('position', '0 0 -12.5');
  box.setAttribute('src', '#netTexture');
  scene.appendChild(box);

</script>

<script>
  var Quaternion = require('quaternion');
 setTimeout( function () { function updatePosition(object, data_6d, objectId) {
    // Extracting the 6D co-rd from the data blob
    object_data = data_6d['components']['6dEuler']['rigidBodies'][objectId];
    ({x, y, z, euler1, euler2, euler3 } = object_data);
    object.setAttribute('position', `${y/50} ${z/50} ${x/50}`);
    object.setAttribute('rotation', `${euler2} ${euler3} ${euler1}`);
  }

  const socket = io('http://192.168.1.100:80')
  const mocap = true;
  const cameraParent = document.getElementById('cameraParent');
  const cameraProxy = document.getElementById('cameraProxy');
  // const firstAvatar = document.getElementById('anAvatar');
  socket.on('frame', (data) => {
    // console.log("socket data recieved",data);
    if(mocap)
    {
      // console.log(cameraProxy.getAttribute('rotation'))
      // console.log(cameraParent.getAttribute('rotation'))

      proxy_rotation = cameraProxy.getAttribute('rotation');
      main_rotation = cameraParent.getAttribute('rotation');
      const lerpSpeed = 0.02;
      var correction = new Quaternion();
      correction = proxy_rotation*Quaternion.inverse(main_rotation);
      console.log(correction);

      // Quaternion correction = cameraProxy.transform.rotation * Quaternion.Inverse(mainCamera.transform.localRotation);
      // // Set the rotation value of this camera to be a portion of the offset, over time this will correct slowly
      // transform.rotation = Quaternion.Lerp(transform.rotation, correction, lerpSpeed);
      // // copy the transform position
      // transform.position = cameraProxy.transform.position;
      updatePosition(cameraParent, data, 0);

      // updatePosition(firstAvatar, data, 45);
    }
    else
    {
      ({x, y, z, euler1, euler2, euler3 } = data);
      cameraParent.setAttribute('position', `${x} ${y} ${z}`);
      cameraParent.setAttribute('rotation', `${euler1} ${euler2} ${euler3}`);
    }

  })}, 2000)
 
</script>
</html>
